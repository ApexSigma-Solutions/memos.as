version: '3.8'

services:
  memos-api:
    build: .
    container_name: devenviro_memos_api
    ports:
      - "8091:8090" # Expose on a different host port to avoid conflicts
    env_file:
      - .env
    environment:
      - NEO4J_URI=bolt://devenviro_neo4j:7687
      - NEO4J_USERNAME=neo4j
      - NEO4J_PASSWORD=password
    # Connect this service to the existing DevEnviro network
    networks:
      - apexsigma_net
    extra_hosts:
      - "devenviro_postgres:172.22.0.10"

  test-runner:
    build: .
    env_file:
      - .env
    environment:
      PYTHONPATH: /code
      API_HOST: memos-api
    networks:
      - apexsigma_net
    command: ["npx", "@dotenvx/dotenvx", "run", "--", "pytest", "-v", "/code/app/tests/"]

networks:
  apexsigma_net:
    # This tells Docker Compose to use an existing network
    external: true
